<!DOCTYPE html>
<html>
    <head>
        <!--<script type="text/javascript" src="script.js"></script>-->
    </head>

    <body>
        <div>
            <h1>
                Student Message Board
            </h1>
        </div>
        <div>
            <h2>
                Course 1234
            </h2>
            <ol id="top20course1234">
            </ol>
            <textarea id ="course1234" rows="4" cols="50" maxlength="200">
            </textarea>    
            <button id = "course1Button">Submit</button>
        </div>
        <div>
            <h2>
                Course 5678
            </h2>
            <ol id="top20course5678">
            </ol>
            <textarea id="course5678" rows="4" cols="50" maxlength="200">
            </textarea>
            <button id="course2Button">Submit</button>
        </div>
        <script>
        //JAVASCRIPT
        
        //Get messages on load
        document.body.onload = function() {
            getMessages();
        };
        
        /*function checkEverySecond(){
            setInterval(getMessages(), 1000);
        }*/
        
        //Call saveMessage when submit buttons are clicked.
        document.getElementById('course1Button').onclick = function() {saveMessage('1234')};
        document.getElementById('course2Button').onclick = function() {saveMessage('5678')};
        
        //Create a node element helper function
        function createNode(element) {
            return document.createElement(element);
        }
        
        //Append an element helper function
        function append(parent, el) {
            return parent.appendChild(el);
        }
        
        //Remove a childNode helper function
        function removeChild(root) {
            while ( root.firstChild ) {
                root.removeChild( root.firstChild );
            }
        }
        
        //Append to list helper function
        function appendToList(ol, li, span, childNodes){
            if(ol.childNodes.length < 20){
                append(li, span);
                append(ol, li);
            } else {
                ol.removeChild(childNodes[0]);
                append(li, span);
                append(ol, li);
            }
        }
        
        //Get all the messages from the database and append them to an ordered list
        function getMessages() {
            //Get ordered list
            const listCourse1 = document.getElementById("top20course1234");
            const listCourse2 = document.getElementById("top20course5678");
            const url = 'https://lab3-klepple.c9users.io:8081/api/messages';
            
            //Clear lists
            removeChild(listCourse1);
            removeChild(listCourse2);
            
            fetch(url)
                .then((resp) => resp.json())
                .then(function(data) {
                    console.log(data);
                    return data.map(function(message) {
                        //Create node
                        let li = createNode('li'),
                        span = createNode('span');
                        span.innerHTML = message.content;
                        span.setAttribute("title", 'ID: ${message._id}');
                        if(message.courseCode == '1234'){
                            appendToList(listCourse1, li, span, listCourse1.childNodes);
                        } else if(message.courseCode == '5678'){
                            appendToList(listCourse2, li, span, listCourse2.childNodes);
                        }
                    })
                })
                .catch(function(error) {
                    console.log(JSON.stringify(error));
                });
        }
        
        //Save message entered into textarea
        function saveMessage(courseCode) {
            //Create message
            let messageBody = {
                courseCode: courseCode,
                content: document.getElementById('course' + courseCode).value,
              	timeStamp: Date.now()
            }
            var encoded = new URLSearchParams(messageBody);
            
            fetch('https://lab3-klepple.c9users.io:8081/api/messages', {
                method: 'POST',
              	headers: {'Content-Type': 'application/x-www-form-urlencoded'},
              	body: encoded,
            }).then(getMessages()); // load the new list
        }
        </script>
    </body>
</html>