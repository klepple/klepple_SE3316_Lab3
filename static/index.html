<!DOCTYPE html>
<html>
    <head>
        <!--<script type="text/javascript" src="script.js"></script>-->
    </head>

    <body onload='getMessages()'>
        <div>
            <h1>
                Student Message Board
            </h1>
        </div>
        <div>
            <h2>
                Course 1
            </h2>
            <ol id="top20course1">
            </ol>
            <textarea id ="course1" rows="4" cols="50" maxlength="200">
            </textarea>    
            <button id = "course1Button">Submit</button>
        </div>
        <div>
            <h2>
                Course 2
            </h2>
            <ol id="top20course2">
            </ol>
            <textarea id="course2" rows="4" cols="50" maxlength="200">
            </textarea>
            <button id = "course2Button">Submit</button>
        </div>
        <script>
        //JAVASCRIPT
        //Call saveMessage when submit buttons are clicked.
        document.getElementById('course1Button').onclick = function() {saveMessage('1')};
        document.getElementById('course2Button').onclick = function() {saveMessage('2')};
        
        //Create a node element helper function
        function createNode(element) {
            return document.createElement(element);
        }
        
        //Append an element helper function
        function append(parent, el) {
            return parent.appendChild(el);
        }
        
        //Get all the messages from the database and append them to an ordered list
        function getMessages() {
            //Get ordered list
            const ol = document.getElementById("top20course1"); //courseCode.toString());
            const url = 'https://lab3-klepple.c9users.io:8082/api/messages';
            fetch(url)
                .then((resp) => resp.json())
                .then(function(data) {
                    console.log(data);
                    return data.map(function(message) {
                    let li = createNode('li'),
                    span = createNode('span');
                    span.innerHTML = message.content;
                    span.setAttribute("courseCode", 'ID: ${message._id}');
                    console.log(li);
                    append(li, span);
                    append(ol, li);
                    })
                })
                .catch(function(error) {
                    console.log(JSON.stringify(error));
                });
        }
        
        //Save message entered into textarea
        function saveMessage(courseCode) {
            let messageBody = {
                courseCode: courseCode,
                content: document.getElementById('course' + courseCode).value,
              	timeStamp: Date.now()
            }
            var encoded = new URLSearchParams(messageBody);
              fetch('https://lab3-klepple.c9users.io:8082/api/messages', {
              	method: 'POST',
              	headers: {'Content-Type': 'application/x-www-form-urlencoded'},
              	body: encoded
              })
              .then(getMessages()); // load the new list
        }
        </script>
    </body>
</html>